<html><head><base href="working">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema de Email Marketing</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">

<style>
:root {
  --primary-color: #2c3e50;
  --secondary-color: #3498db;
}

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: #f5f6fa;
}

.navbar {
  background: var(--primary-color);
  padding: 1rem;
}

.navbar-brand {
  color: white !important;
  font-weight: bold;
}

.main-container {
  padding: 2rem;
}

.card {
  border: none;
  border-radius: 10px;
  box-shadow: 0 0 20px rgba(0,0,0,0.1);
  margin-bottom: 2rem;
}

.card-header {
  background: var(--secondary-color);
  color: white;
  font-weight: bold;
  border-radius: 10px 10px 0 0;
}

.form-control {
  border-radius: 5px;
  border: 1px solid #ddd;
  padding: 0.8rem;
}

.btn-primary {
  background: var(--secondary-color);
  border: none;
  padding: 0.8rem 1.5rem;
  font-weight: 600;
}

.btn-primary:hover {
  background: #2980b9;
}

#csvPreview {
  max-height: 200px;
  overflow-y: auto;
}

.progress {
  height: 25px;
  margin: 1rem 0;
}

#templatePreview {
  border: 1px solid #ddd;
  padding: 1rem;
  border-radius: 5px;
  min-height: 200px;
}

.status-badge {
  padding: 0.5rem 1rem;
  border-radius: 20px;
  font-size: 0.9rem;
}
</style>
</head>
<body>

<nav class="navbar navbar-expand-lg">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">
      <svg width="30" height="30" viewBox="0 0 24 24" fill="white" style="margin-right: 10px;">
        <path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H4V8l8 5 8-5v10zm-8-7L4 6h16l-8 5z"/>
      </svg>
      Email Marketing Pro
    </a>
  </div>
</nav>

<div class="container main-container">
  <div class="row">
    <!-- Import de Contatos -->
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          Importar Contatos
        </div>
        <div class="card-body">
          <div class="mb-3">
            <label class="form-label">Upload CSV/Excel</label>
            <input type="file" class="form-control" id="contactsFile" accept=".csv,.xlsx">
          </div>
          <div id="csvPreview" class="table-responsive">
            <!-- Preview será mostrado aqui -->
          </div>
        </div>
      </div>
    </div>

    <!-- Template do Email -->
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          Template do Email
        </div>
        <div class="card-body">
          <div class="mb-3">
            <label class="form-label">Assunto</label>
            <input type="text" class="form-control" id="emailSubject" placeholder="Digite o assunto do email">
          </div>
          <div class="mb-3">
            <label class="form-label">Conteúdo</label>
            <div id="emailEditor">
              <!-- Editor será inicializado aqui -->
            </div>
          </div>
          <div id="templatePreview">
            <!-- Preview do template será mostrado aqui -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Configurações de Envio -->
  <div class="card">
    <div class="card-header">
      Configurações de Envio
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <div class="mb-3">
            <label class="form-label">Servidor SMTP</label>
            <input type="text" class="form-control" id="smtpServer" placeholder="smtp.seuservidor.com">
          </div>
          <div class="mb-3">
            <label class="form-label">Porta</label>
            <input type="number" class="form-control" id="smtpPort" placeholder="587">
          </div>
        </div>
        <div class="col-md-6">
          <div class="mb-3">
            <label class="form-label">Email</label>
            <input type="email" class="form-control" id="smtpEmail" placeholder="seu@email.com">
          </div>
          <div class="mb-3">
            <label class="form-label">Senha</label>
            <input type="password" class="form-control" id="smtpPassword">
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Status e Controles -->
  <div class="card">
    <div class="card-header">
      Status do Envio
    </div>
    <div class="card-body">
      <div class="progress">
        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
      </div>
      <div class="d-flex justify-content-between align-items-center mt-3">
        <div>
          <span class="status-badge bg-info" id="totalEmails">Total: 0</span>
          <span class="status-badge bg-success" id="sentEmails">Enviados: 0</span>
          <span class="status-badge bg-danger" id="failedEmails">Falhas: 0</span>
        </div>
        <div>
          <button class="btn btn-secondary" id="testEmail">Enviar Teste</button>
          <button class="btn btn-primary" id="startCampaign">Iniciar Campanha</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.tiny.cloud/1/no-api-key/tinymce/5/tinymce.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
// Inicialização do TinyMCE
tinymce.init({
    selector: '#emailEditor',
    height: 300,
    menubar: false,
    plugins: [
        'advlist autolink lists link image charmap print preview anchor',
        'searchreplace visualblocks code fullscreen',
        'insertdatetime media table paste code help wordcount'
    ],
    toolbar: 'undo redo | formatselect | bold italic backcolor | \
        alignleft aligncenter alignright alignjustify | \
        bullist numlist outdent indent | removeformat | help'
});

// Variáveis globais
let contacts = [];
let currentProgress = 0;

// Manipulador de upload de arquivo
document.getElementById('contactsFile').addEventListener('change', function(e) {
    const file = e.target.files[0];
    const reader = new FileReader();

    reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, {type: 'array'});
        
        // Pega a primeira planilha
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        contacts = XLSX.utils.sheet_to_json(firstSheet);

        // Só atualiza se houver contatos
        if (contacts && contacts.length > 0) {
            updateContactsPreview();
            updateTotalCount();
        } else {
            Swal.fire('Erro', 'Nenhum contato encontrado no arquivo!', 'error');
        }
    };

    reader.onerror = function() {
        Swal.fire('Erro', 'Erro ao ler o arquivo!', 'error');
    };

    reader.readAsArrayBuffer(file);
});

// Função para atualizar preview dos contatos
function updateContactsPreview() {
    const preview = document.getElementById('csvPreview');
    
    // Verifica se há contatos e se o primeiro contato existe
    if (!contacts || !contacts.length || !contacts[0]) {
        preview.innerHTML = '<div class="alert alert-warning">Nenhum contato para exibir</div>';
        return;
    }

    let html = '<table class="table"><thead><tr>';
    
    // Headers
    const headers = Object.keys(contacts[0]);
    headers.forEach(header => {
        html += `<th>${header}</th>`;
    });
    html += '</tr></thead><tbody>';

    // Dados (primeiros 5 registros)
    contacts.slice(0, 5).forEach(row => {
        html += '<tr>';
        headers.forEach(header => {
            html += `<td>${row[header] || ''}</td>`;
        });
        html += '</tr>';
    });

    html += '</tbody></table>';
    preview.innerHTML = html;
}

// Atualizar contagem total
function updateTotalCount() {
    document.getElementById('totalEmails').textContent = `Total: ${contacts.length || 0}`;
}

// Função para enviar email teste
document.getElementById('testEmail').addEventListener('click', async function() {
    const result = await Swal.fire({
        title: 'Enviar email teste',
        input: 'email',
        inputLabel: 'Digite o email para teste',
        inputPlaceholder: 'email@exemplo.com',
        showCancelButton: true,
        confirmButtonText: 'Enviar',
        cancelButtonText: 'Cancelar',
        inputValidator: (value) => {
            if (!value) {
                return 'Digite um email válido!';
            }
        }
    });

    if (result.isConfirmed) {
        // Simular envio de teste
        await simulateEmailSend(result.value);
        Swal.fire('Sucesso!', 'Email de teste enviado!', 'success');
    }
});

// Função para iniciar campanha
document.getElementById('startCampaign').addEventListener('click', async function() {
    const result = await Swal.fire({
        title: 'Iniciar campanha?',
        text: `Serão enviados ${contacts.length} emails`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Iniciar',
        cancelButtonText: 'Cancelar'
    });

    if (result.isConfirmed) {
        startEmailCampaign();
    }
});

// Simular envio de email individual
async function simulateEmailSend(email) {
    return new Promise(resolve => {
        setTimeout(() => {
            console.log(`Email enviado para: ${email}`);
            resolve(true);
        }, 1000);
    });
}

// Iniciar campanha de email
async function startEmailCampaign() {
    const progressBar = document.querySelector('.progress-bar');
    const sentCount = document.getElementById('sentEmails');
    const failedCount = document.getElementById('failedEmails');
    let sent = 0;
    let failed = 0;

    for (let i = 0; i < contacts.length; i++) {
        try {
            await simulateEmailSend(contacts[i].email);
            sent++;
            sentCount.textContent = `Enviados: ${sent}`;
        } catch (error) {
            failed++;
            failedCount.textContent = `Falhas: ${failed}`;
        }

        // Atualizar progresso
        const progress = ((i + 1) / contacts.length) * 100;
        progressBar.style.width = `${progress}%`;
    }

    Swal.fire(
        'Campanha finalizada!',
        `Enviados: ${sent}, Falhas: ${failed}`,
        'success'
    );
}

// Validações dos campos SMTP
const smtpFields = ['smtpServer', 'smtpPort', 'smtpEmail', 'smtpPassword'];
smtpFields.forEach(field => {
    document.getElementById(field).addEventListener('change', function(e) {
        if (!e.target.value) {
            e.target.classList.add('is-invalid');
        } else {
            e.target.classList.remove('is-invalid');
        }
    });
});
</script>

</body>
</html>